{% extends ':layout:master.html.twig' %}
{% block customStylesheet %}

{% endblock %}
{% block content %}
    <section id="dashboard">
        <div class="col-lg-12">
            <h3 class="page-header"><i class="fa fa-code"></i> Code</h3>
            <ol class="breadcrumb">
                <li><i class="fa fa-code"></i><a href="{{ path('article-main') }}">Code</a></li>
            </ol>
        </div>
        <div class="col-md-12">
            <div class="col-md-12" id="code-container">
                <div class="col-md-4">
                    <h3>Css</h3>
                    <textarea class="code-css" id="code-css" rows="15" style="width: 100%"></textarea>
                </div>
                <div class="col-md-4">
                    <h3>HTML</h3>
                    <textarea class="code-html" id="code-html" rows="15" style="width: 100%"></textarea>
                </div>
                <div class="col-md-4">
                    <h3>JavaScript</h3>
                    <textarea class="code-js" id="code-js" rows="15" style="width: 100%"></textarea>
                </div>
            </div>
        </div>
        <div class="col-md-12">
            <button id="dugme">uradi</button>
            <iframe src="" frameborder="0" id="view">
                <div id="script"></div>
            </iframe>
        </div>
    </section>
{% endblock %}
{% block customScripts %}
    {% include('Code/scripts.html.twig') %}
    <script>
        $(document).ready(function(){

        });
        view = $('#view');
        ace.require("ace/ext/language_tools");
        var editor = ace.edit("code-html");
        var css = ace.edit("code-css");
        var js = ace.edit("code-js");
        editor.getSession().setMode("ace/mode/html");
        css.getSession().setMode("ace/mode/css");
        js.getSession().setMode("ace/mode/javascript");
        editor.setTheme("ace/theme/monokai");
        css.setTheme("ace/theme/monokai");
        js.setTheme("ace/theme/monokai");

        var context = "var iframe = document.getElementById('view');" +
                " var innerDoc = (iframe.contentDocument) ? iframe.contentDocument : iframe.contentWindow.document;";

        $('#dugme').on('click', function () {
//            var parsedJs = parse(js.getSession().getValue());
            view.contents().find('body').html(editor.getSession().getValue()+"<"+"script>"+context+"</"+"script>");
        });
        css.getSession().on('change', function () {
            var bootstrap="<link rel='stylesheet' href='{{ asset('Base/css/bootstrap.min.css') }}'>";
            view.contents().find('head').html(bootstrap+"<style>"+css.getSession().getValue()+"</style>");
        });
        $('#dugme').on('click', function () {
            if(js.getSession().getValue()!=''){
                var parsedJs = parse(js.getSession().getValue());
                console.log(parsedJs);
                var jquery= "<script src='{{ asset('Base/js/jquery-2.1.3.js') }}'><\/script>";
                view.contents().find('body').html(""+jquery+""+editor.getSession().getValue()+"<"+"script>"+context+parsedJs+"<\/script>");
            }
        });

        function parse(code){
            var code = code.replace(/'/g, '"');
            var regex = /\$\("(#|\.).+"\)/g;
            var selectors = code.match(regex);
            if(selectors!=null){
                var tmpSelectors = [selectors.length];
                for (var i =0; i<selectors.length; i++){
                    tmpSelectors[i] = selectors[i].substring(3, selectors[i].length-2);
                    tmpSelectors[i]= "$(innerDoc).find('"+tmpSelectors[i]+"')";
                    var code= code.replace(selectors[i], tmpSelectors[i]);
                }
                return code.replace(/(')/gm,"\'");
            }
            else {
                return "";
            }
        }

        //            KEY TO MAKE IT WORK
        //        var iframe = document.getElementById('view');
        //        var innerDoc = (iframe.contentDocument) ? iframe.contentDocument : iframe.contentWindow.document;
        //        var a = $(innerDoc).find('#a');
        //        a.click(function(){
        //            alert('daads');
        //        });
        //        a.text('Novi');
    </script>
{% endblock %}

